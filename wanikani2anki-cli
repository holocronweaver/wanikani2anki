#! /usr/bin/env python3
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v2.0. If a copy of the MPL was not distributed with this
# file, you can obtain one at http://mozilla.org/MPL/2.0/.
"""A CLI for converting WaniKani user data to an Anki deck.
"""
import os

from wanikani2anki import WaniKani, WaniKani2Anki

from options import *

wk = WaniKani()
wk2a = WaniKani2Anki(wk)

if not apikey:
    apikey = input('WaniKani API V2 key (not V1!): ')
user, userpath = wk.get_user(apikey, users_cache)

print('''Fetching information for
      user:  {username}
      level: {level}
'''.format(**user['wanikani']['data']))

data = wk.get_data(user, userpath, general_cache)

options = wk2a.create_options(user)

deck = wk2a.create_deck(user, data, options)

media = wk2a.get_media(media_formats, media_dir)

print('Writing deck...')
filepath = os.path.join(userpath, 'WaniKani.apkg')
if os.path.isfile(filepath):
    os.remove(filepath)
wk2a.write_deck_to_file(filepath, deck, media)
print('All done.')
